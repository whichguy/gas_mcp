<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gas Debugger Console</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    :root {
      --bg-primary: #1e1e1e;
      --bg-secondary: #252526;
      --bg-tertiary: #2d2d30;
      --border: #3e3e42;
      --text-primary: #cccccc;
      --text-secondary: #969696;
      --accent: #007acc;
      --success: #89d185;
      --warning: #d7ba7d;
      --error: #f48771;
      --info: #75beff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow: hidden;
      height: 100vh;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 16px;
      gap: 12px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }

    .header .status {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .main-content {
      flex: 1;
      display: flex;
      gap: 12px;
      min-height: 0;
      overflow: hidden;
    }

    .panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
      cursor: move;
      user-select: none;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .panel-actions {
      display: flex;
      gap: 8px;
    }

    .panel-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .panel-btn:hover {
      background: var(--bg-primary);
      border-color: var(--accent);
      color: var(--accent);
    }

    .toggle-panel-arrow {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s ease;
      padding: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-panel-arrow:hover {
      color: var(--accent);
    }

    .panel.collapsed .toggle-panel-arrow {
      transform: rotate(-90deg);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
    }

    .output-panel {
      flex: 1;
      min-width: 400px;
    }

    .context-panel {
      width: 320px;
      min-width: 250px;
    }

    .resizer {
      width: 8px;
      background: transparent;
      cursor: col-resize;
      position: relative;
      flex-shrink: 0;
    }

    .resizer:hover {
      background: var(--accent);
      opacity: 0.3;
    }

    .resizer:active {
      background: var(--accent);
      opacity: 0.5;
    }

    .output-line {
      padding: 6px 10px;
      border-left: 3px solid transparent;
      margin: 2px 0;
      border-radius: 3px;
      font-size: 12px;
    }

    .output-line.success {
      border-left-color: var(--success);
      background: rgba(137, 209, 133, 0.1);
    }

    .output-line.error {
      border-left-color: var(--error);
      background: rgba(244, 135, 113, 0.1);
    }

    .output-line.warning {
      border-left-color: var(--warning);
      background: rgba(215, 186, 125, 0.1);
    }

    .output-line.info {
      border-left-color: var(--info);
      background: rgba(117, 190, 255, 0.1);
    }

    .output-line .timestamp {
      color: var(--text-secondary);
      font-size: 11px;
      margin-right: 8px;
    }

    .execution-time {
      color: var(--text-secondary);
      font-size: 10px;
      margin-left: 8px;
      font-style: italic;
    }

    .server-logs {
      margin-top: 4px;
      margin-left: 20px;
      border-left: 2px solid var(--border);
      padding-left: 8px;
      font-size: 11px;
    }

    .server-logs-header {
      cursor: pointer;
      user-select: none;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 0;
      font-weight: 500;
    }

    .server-logs-header:hover {
      color: var(--accent);
    }

    .server-logs-arrow {
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 10px;
    }

    .server-logs.collapsed .server-logs-arrow {
      transform: rotate(-90deg);
    }

    .server-logs-content {
      margin-top: 4px;
      padding: 6px 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 3px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 10px;
      line-height: 1.4;
    }

    .server-logs.collapsed .server-logs-content {
      display: none;
    }

    .input-container {
      padding: 12px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
    }

    .input-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .input-field {
      flex: 1;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 10px 12px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      border-color: var(--accent);
    }

    .execute-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .execute-btn:hover {
      background: #005a9e;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
    }

    .execute-btn:active {
      transform: translateY(0);
    }

    .context-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .context-section:last-child {
      border-bottom: none;
    }

    .context-section h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .context-section h3:hover {
      color: var(--text-primary);
    }

    .expand-icon {
      display: inline-block;
      font-size: 12px;
      transition: transform 0.2s ease;
      transform: rotate(90deg);
    }

    .context-section.collapsed .expand-icon {
      transform: rotate(0deg);
    }

    .context-section.collapsed .context-section-content {
      display: none;
    }

    .context-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      margin: 4px 0;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 12px;
    }

    .context-item .key {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .context-item .value {
      color: var(--text-primary);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .scroll-hint {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-secondary);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .scroll-hint.visible {
      opacity: 1;
    }

    .panel-content::-webkit-scrollbar {
      width: 10px;
    }

    .panel-content::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    .panel-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
    }

    .panel-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    .collapsed {
      height: 48px;
    }

    .collapsed .panel-content {
      display: none;
    }

    .nav-tabs {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0;
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
      overflow-x: auto;
      flex-wrap: nowrap;
    }

    .nav-tabs .nav-item {
      margin: 0;
    }

    .nav-tabs .nav-link {
      display: block;
      padding: 10px 16px;
      text-decoration: none;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .nav-tabs .nav-link:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-tabs .nav-link.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      font-size: 12px;
    }

    .info-label {
      color: var(--text-secondary);
      font-weight: 600;
    }

    .info-value {
      color: var(--text-primary);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-indicator.healthy {
      background: var(--success);
    }

    .status-indicator.warning {
      background: var(--warning);
    }

    .status-indicator.error {
      background: var(--error);
    }

    .trigger-item, .process-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .trigger-header, .process-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .trigger-function, .process-function {
      font-weight: 600;
      color: var(--accent);
    }

    .trigger-type, .process-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 3px;
      background: var(--bg-primary);
    }

    .process-status.COMPLETED {
      color: var(--success);
    }

    .process-status.FAILED {
      color: var(--error);
    }

    .process-status.RUNNING {
      color: var(--info);
    }

    .log-viewer {
      max-height: 300px;
      overflow-y: auto;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }

      .context-panel {
        width: 100%;
        max-height: 300px;
      }

      .resizer {
        width: 100%;
        height: 8px;
        cursor: row-resize;
      }

      .header {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }

      .header .status {
        flex-direction: column;
        gap: 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Gas Debugger Console</h1>
      <div class="status">
        <span>Script ID: <strong id="scriptId" title="Click to copy" style="cursor: pointer;">Loading...</strong></span>
        <span>User: <strong id="userEmail">Loading...</strong></span>
        <button class="panel-btn" id="openEditorBtn" style="margin-left: 16px;">Open in Editor</button>
      </div>
    </div>

    <div class="main-content">
      <div class="panel context-panel">
        <div class="panel-header">
          <span class="panel-title">Context</span>
          <div class="panel-actions">
            <button class="toggle-panel-arrow toggle-panel" title="Collapse panel">▼</button>
          </div>
        </div>
        <div class="panel-content">
          <ul class="nav-tabs">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-tab="contextTab">Context</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-tab="loggerTab">Logger</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-tab="deploymentTab">Deployment</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-tab="triggersTab">Triggers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-tab="processesTab">Processes</a>
            </li>
          </ul>

          <div id="contextTab" class="tab-content active">
            <div class="context-section">
              <h3>
                <span class="expand-icon">▶</span>Client State
                <button class="panel-btn" id="clearClientState" style="margin-left: auto; font-size: 10px; padding: 2px 8px;" title="Clear all client state">✕ Clear</button>
              </h3>
              <div class="context-section-content">
                <div id="clientState" class="empty-state">No variables stored</div>
              </div>
            </div>

            <div class="context-section collapsed">
              <h3><span class="expand-icon">▶</span>Session Info</h3>
              <div class="context-section-content">
                <div id="sessionInfo">
                  <div class="context-item">
                    <span class="key">Timezone</span>
                    <span class="value" id="timezone">-</span>
                  </div>
                  <div class="context-item">
                    <span class="key">Locale</span>
                    <span class="value" id="locale">-</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="context-section collapsed">
              <h3>
                <span class="expand-icon">▶</span>Script Properties
                <button class="panel-btn" id="refreshScriptProps" style="margin-left: auto; font-size: 10px; padding: 2px 8px;" title="Refresh script properties">↻</button>
                <button class="panel-btn" id="addScriptProp" style="font-size: 10px; padding: 2px 8px;" title="Add new property">+</button>
              </h3>
              <div class="context-section-content">
                <div id="scriptProps" class="empty-state">Loading...</div>
              </div>
            </div>
          </div>

          <div id="loggerTab" class="tab-content">
            <div class="context-section">
              <h3><span class="expand-icon">▶</span>Recent Logs</h3>
              <div class="context-section-content">
                <div id="recentLogs" class="log-viewer">No recent logs</div>
              </div>
            </div>
          </div>

          <div id="deploymentTab" class="tab-content">
            <div class="context-section">
              <h3><span class="expand-icon">▶</span>Deployment Info</h3>
              <div class="context-section-content">
                <div class="info-grid">
                  <span class="info-label">Web App URL:</span>
                  <span class="info-value" id="deploymentUrl">N/A</span>

                  <span class="info-label">Health:</span>
                  <span class="info-value">
                    <span class="status-indicator healthy" id="deploymentHealth"></span>
                    <span id="deploymentHealthText">Active</span>
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div id="triggersTab" class="tab-content">
            <div class="context-section">
              <h3><span class="expand-icon">▶</span>Active Triggers</h3>
              <div class="context-section-content">
                <div id="triggersList" class="empty-state">Click to load triggers...</div>
              </div>
            </div>
          </div>

          <div id="processesTab" class="tab-content">
            <div class="context-section">
              <h3>
                <span class="expand-icon">▶</span>Recent Processes
                <button class="panel-btn" id="refreshProcesses" style="margin-left: auto; font-size: 10px; padding: 2px 8px;" title="Refresh processes">↻</button>
              </h3>
              <div class="context-section-content">
                <div id="processesList" class="empty-state">Click to load processes...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="resizer" id="resizer"></div>

      <div class="panel output-panel">
        <div class="panel-header">
          <span class="panel-title">Output</span>
          <div class="panel-actions">
            <button class="panel-btn clear-output">Clear</button>
            <button class="toggle-panel-arrow toggle-panel" title="Collapse panel">▼</button>
          </div>
        </div>
        <div class="panel-content" id="output">
          <div class="empty-state">Execute code to see output here</div>
        </div>
        <div class="scroll-hint" id="scrollHint">New output</div>
        <div class="input-container">
          <div class="input-wrapper">
            <input
              type="text"
              class="input-field"
              id="codeInput"
              placeholder="Enter JavaScript code or use run(<javascript>) to execute server-side code..."
            >
            <button class="execute-btn">Execute</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Command history management
    window.commandHistory = {
      commands: [],
      currentIndex: -1,
      add(command) {
        if (command && command.trim()) {
          this.commands.push(command);
          this.currentIndex = this.commands.length;
        }
      },
      getPrevious() {
        if (this.commands.length === 0) return '';
        if (this.currentIndex > 0) {
          this.currentIndex--;
        }
        return this.commands[this.currentIndex] || '';
      },
      getNext() {
        if (this.commands.length === 0) return '';
        if (this.currentIndex < this.commands.length - 1) {
          this.currentIndex++;
          return this.commands[this.currentIndex];
        } else {
          this.currentIndex = this.commands.length;
          return '';
        }
      }
    };

    // GLOBAL clientState object accessible from console
    window.clientState = {
      storage: {},
      set: (key, value) => {
        clientState.storage[key] = value;
        window.UI?.updateClientState();
        window.UI?.addOutput(`Set ${key} = ${JSON.stringify(value)}`, 'success');
        return value;
      },
      get: key => clientState.storage[key],
      delete: key => {
        delete clientState.storage[key];
        window.UI?.updateClientState();
        window.UI?.addOutput(`Deleted ${key}`, 'info');
      },
      clear: () => {
        clientState.storage = {};
        window.UI?.updateClientState();
        window.UI?.addOutput('Cleared all client state', 'info');
      },
      run: statement => new Promise((resolve, reject) => {
        const startTime = performance.now();

        if (typeof google === 'undefined' || !google.script?.run) {
          const clientTime = (performance.now() - startTime).toFixed(2);
          window.UI?.addOutput(
            `⚠️ Server execution not available in /dev mode. Deploy as web app to use run().`,
            'warning',
            `client: ${clientTime}ms`
          );
          reject(new Error('google.script.run not available in /dev mode'));
          return;
        }

        try {
          google.script.run
            .withSuccessHandler(response => {
              const clientTime = (performance.now() - startTime).toFixed(2);
              
              // Extract result and logger_output from response
              // The response structure depends on what invoke() returns
              let result = response;
              let serverLogs = null;
              
              // Check if response has logger_output (from full response object)
              if (response && typeof response === 'object' && 'logger_output' in response) {
                result = response.result;
                serverLogs = response.logger_output;
              }
              
              window.UI?.addOutput(
                `Result: ${JSON.stringify(result)}`,
                'success',
                `client: ${clientTime}ms`,
                serverLogs
              );
              
              // Auto-refresh Processes tab if it's currently active
              if ($('.nav-link[data-tab="processesTab"]').hasClass('active')) {
                window.DataLoader?.loadProcesses();
              }
              
              resolve(result);
            })
            .withFailureHandler(error => {
              const clientTime = (performance.now() - startTime).toFixed(2);
              window.UI?.addOutput(
                `Error: ${error.message}`,
                'error',
                `client: ${clientTime}ms`
              );
              reject(error);
            })
            .invoke(statement);
        } catch (error) {
          const clientTime = (performance.now() - startTime).toFixed(2);
          window.UI?.addOutput(
            `⚠️ Server execution not available in /dev mode. Deploy as web app to use run().`,
            'warning',
            `client: ${clientTime}ms`
          );
          reject(new Error('google.script.run not available in /dev mode'));
        }
      })
    };

    $(() => {
      // ES6 UI Manager with execution time tracking
      window.UI = {
        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        },

        addOutput(message, type = 'info', executionTime = null, serverLogs = null) {
          const $output = $('#output');
          $output.find('.empty-state').remove();

          const timestamp = new Date().toLocaleTimeString();
          const escapedMessage = this.escapeHtml(String(message));
          const timeInfo = executionTime ? `<span class="execution-time">${executionTime}</span>` : '';

          const $line = $('<div>').addClass(`output-line ${type}`).html(`
            <span class="timestamp">[${timestamp}]</span>
            <span>${type.charAt(0).toUpperCase() + type.slice(1)}: ${escapedMessage}</span>
            ${timeInfo}
          `);

          // Add collapsible server logs if present
          if (serverLogs && serverLogs.trim()) {
            const escapedLogs = this.escapeHtml(String(serverLogs));
            const $logsSection = $('<div>').addClass('server-logs collapsed').html(`
              <div class="server-logs-header">
                <span class="server-logs-arrow">▼</span>
                <span>Server Logs</span>
              </div>
              <div class="server-logs-content">${escapedLogs}</div>
            `);

            // Add click handler for toggle
            $logsSection.find('.server-logs-header').on('click', function() {
              $(this).closest('.server-logs').toggleClass('collapsed');
            });

            $line.append($logsSection);
          }

          $output.append($line);

          const output = $output[0];
          const isScrolledToBottom = output.scrollHeight - output.clientHeight <= output.scrollTop + 50;

          if (isScrolledToBottom) {
            output.scrollTop = output.scrollHeight;
          } else {
            window.UI.showScrollHint();
          }
        },

        showScrollHint() {
          $('#scrollHint').addClass('visible').delay(3000).queue(function() {
            $(this).removeClass('visible').dequeue();
          });
        },

        clearOutput() {
          $('#output').html('<div class="empty-state">Output cleared</div>');
        },

        renderNestedValue(value, depth = 0, maxDepth = 10, seen = new WeakSet()) {
          const indent = depth * 12; // 12px indentation per level
          const type = Array.isArray(value) ? 'array' : typeof value;
          const typeColor = {
            string: '#ce9178',
            number: '#b5cea8',
            boolean: '#569cd6',
            object: '#4ec9b0',
            array: '#4ec9b0',
            function: '#dcdcaa',
            undefined: '#808080',
            null: '#808080'
          }[type] || '#cccccc';

          // Check for max depth
          if (depth > maxDepth) {
            return `<span class="value" style="color: var(--warning);">[Max Depth Reached]</span>`;
          }

          // Primitives - no expansion
          if (value === null || value === undefined || typeof value !== 'object') {
            const displayValue = value === null ? 'null' : value === undefined ? 'undefined' : String(value);
            const escapedValue = this.escapeHtml(displayValue);
            return `<span class="value" style="color: ${typeColor};">${escapedValue}</span>`;
          }

          // Check for circular references
          if (seen.has(value)) {
            return `<span class="value" style="color: var(--warning);">[Circular Reference]</span>`;
          }
          seen.add(value);

          // Objects and Arrays - with expansion
          const isArray = Array.isArray(value);
          const entries = isArray ? value.map((v, i) => [i, v]) : Object.entries(value);
          const preview = isArray ? `Array(${entries.length})` : `Object{${entries.length}}`;

          if (entries.length === 0) {
            return `<span class="value" style="color: ${typeColor};">${isArray ? '[]' : '{}'}</span>`;
          }

          const uniqueId = 'var_' + Math.random().toString(36).substr(2, 9);

          let html = `
            <div style="margin-left: ${indent}px;">
              <div style="cursor: pointer; user-select: none;" class="expandable-header" data-target="${uniqueId}">
                <span class="expand-arrow" style="display: inline-block; transition: transform 0.2s; font-size: 10px;">▼</span>
                <span style="color: ${typeColor};">${preview}</span>
              </div>
              <div id="${uniqueId}" class="expandable-content" style="margin-left: 12px;">
          `;

          entries.forEach(([key, val]) => {
            const keyDisplay = isArray ? `[${key}]` : key;
            const escapedKey = this.escapeHtml(String(keyDisplay));
            html += `
              <div style="margin: 2px 0;">
                <span class="key" style="color: var(--text-secondary); font-size: 11px;">${escapedKey}: </span>
                ${this.renderNestedValue(val, depth + 1, maxDepth, seen)}
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;

          return html;
        },

        updateClientState() {
          const keys = Object.keys(clientState.storage);
          const $stateDiv = $('#clientState');

          if (keys.length === 0) {
            $stateDiv.html('<div class="empty-state">No variables stored</div>');
            return;
          }

          const html = keys.map(key => {
            const value = clientState.storage[key];
            const type = Array.isArray(value) ? 'array' : typeof value;
            const typeColor = {
              string: '#ce9178',
              number: '#b5cea8',
              boolean: '#569cd6',
              object: '#4ec9b0',
              array: '#4ec9b0',
              function: '#dcdcaa',
              undefined: '#808080'
            }[type] || '#cccccc';

            const escapedKey = this.escapeHtml(String(key));
            const escapedType = this.escapeHtml(String(type));

            return `
              <div class="context-item" style="display: block; padding: 8px;">
                <div>
                  <span class="key">${escapedKey} <span style="color: ${typeColor}; font-size: 10px; font-style: italic;">(${escapedType})</span></span>
                </div>
                <div style="margin-top: 4px;">
                  ${this.renderNestedValue(value, 0)}
                </div>
              </div>
            `;
          }).join('');

          $stateDiv.html(html);

          // Attach click handlers for expandable items
          $('.expandable-header').on('click', function() {
            const $this = $(this);
            const targetId = $this.data('target');
            const $content = $(`#${targetId}`);
            const $arrow = $this.find('.expand-arrow');

            $content.slideToggle(200);
            $arrow.css('transform', $content.is(':visible') ? 'rotate(0deg)' : 'rotate(-90deg)');
          });
        },

        switchTab(tabId) {
          $('.nav-link').removeClass('active');
          $(`.nav-link[data-tab="${tabId}"]`).addClass('active');
          $('.tab-content').removeClass('active');
          $(`#${tabId}`).addClass('active');

          const loaders = {
            loggerTab: window.DataLoader.loadRecentLogs,
            deploymentTab: window.DataLoader.loadDeploymentInfo,
            triggersTab: window.DataLoader.loadTriggers,
            processesTab: window.DataLoader.loadProcesses
          };

          loaders[tabId]?.();
        },

        togglePanel($btn) {
          const $panel = $btn.closest('.panel');
          const isCollapsed = $panel.toggleClass('collapsed').hasClass('collapsed');
          $btn.attr('title', isCollapsed ? 'Expand panel' : 'Collapse panel');
          localStorage.setItem($panel.attr('class'), isCollapsed ? 'collapsed' : 'expanded');
        },

        restorePanelStates() {
          $('.panel').each((_, panel) => {
            const $panel = $(panel);
            if (localStorage.getItem($panel.attr('class')) === 'collapsed') {
              $panel.addClass('collapsed');
              $panel.find('.toggle-panel').text('Expand');
            }
          });
        }
      };

      // ES6 Data Loader
      window.DataLoader = {
        loadRecentLogs() {
          const $logs = $('#recentLogs').html('<div class="loading"></div>');

          if (typeof google === 'undefined' || !google.script?.run) {
            $logs.html('Not available (google.script.run not loaded)');
            return;
          }

          clientState.run('getFormattedLogs()')
            .then(logEntries => {
              if (!logEntries || logEntries.length === 0) {
                $logs.html('<div class="empty-state">No logs available</div>');
                return;
              }

              const tableRows = logEntries.map(entry => {
                const escapedTimestamp = entry.timestamp ? window.UI.escapeHtml(String(entry.timestamp)) : '';
                const escapedMessage = window.UI.escapeHtml(String(entry.message || ''));

                if (entry.timestamp) {
                  return `<tr><td style="color: var(--text-secondary); font-size: 10px; white-space: nowrap;">${escapedTimestamp}</td><td>${escapedMessage}</td></tr>`;
                }
                return `<tr><td colspan="2">${escapedMessage}</td></tr>`;
              }).join('');

              $logs.html(`
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                  <tbody>
                    ${tableRows}
                  </tbody>
                </table>
              `);
            })
            .catch(error => {
              const escapedError = window.UI.escapeHtml(String(error.message || 'Unknown error'));
              $logs.html(`<div class="empty-state">Error loading logs: ${escapedError}</div>`);
            });
        },

        loadDeploymentInfo() {
          const $url = $('#deploymentUrl');

          if (typeof google === 'undefined' || !google.script?.run) {
            $url.text('Not available (google.script.run not loaded)').css('color', 'var(--text-secondary)');
            return;
          }

          $url.text('Loading...');

          clientState.run('ScriptApp.getService().getUrl()')
            .then(url => {
              if (url) {
                const escapedUrl = window.UI.escapeHtml(String(url));

                // Add debugging URL hints - append parameters to existing URL
                const debugUrl = `${url}${url.includes('?') ? '&' : '?'}_mcp_run=true&action=auth_ide`;
                const escapedDebugUrl = window.UI.escapeHtml(String(debugUrl));

                // Determine current mode based on URL
                const currentMode = window.location.href.includes('?_mcp_run=true&action=auth_ide') || window.location.href.includes('?ui=debugger')
                  ? 'DEBUG'
                  : window.location.href.includes('?_mcp_run=true&func=')
                  ? 'API'
                  : 'PRODUCTION';

                $url.html(`
                  <div style="margin-bottom: 8px;">
                    <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">Base URL:</div>
                    <a href="${escapedUrl}" target="_blank" style="color: var(--accent); font-size: 11px; word-break: break-all;">${escapedUrl}</a>
                  </div>
                  <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                    <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 6px;">Access Modes:</div>
                    <div style="font-size: 11px; line-height: 1.8;">
                      <div ${currentMode === 'DEBUG' ? 'style="background: rgba(0, 122, 204, 0.1); padding: 4px; border-radius: 3px;"' : ''}>
                        <strong style="color: var(--info);">DEBUG:</strong>
                        <a href="${escapedDebugUrl}" target="_blank" style="color: var(--accent); text-decoration: none;">
                          ?_mcp_run=true&action=auth_ide
                        </a>
                        ${currentMode === 'DEBUG' ? '<span style="color: var(--success); margin-left: 8px;">← Current</span>' : ''}
                      </div>
                      <div style="margin-top: 4px;" ${currentMode === 'API' ? 'style="background: rgba(0, 122, 204, 0.1); padding: 4px; border-radius: 3px;"' : ''}>
                        <strong style="color: var(--warning);">API:</strong>
                        <span style="color: var(--text-secondary);">?_mcp_run=true&func=yourCode</span>
                        ${currentMode === 'API' ? '<span style="color: var(--success); margin-left: 8px;">← Current</span>' : ''}
                      </div>
                      <div style="margin-top: 4px;" ${currentMode === 'PRODUCTION' ? 'style="background: rgba(0, 122, 204, 0.1); padding: 4px; border-radius: 3px;"' : ''}>
                        <strong style="color: var(--success);">PROD:</strong>
                        <span style="color: var(--text-secondary);">No parameters (landing page)</span>
                        ${currentMode === 'PRODUCTION' ? '<span style="color: var(--success); margin-left: 8px;">← Current</span>' : ''}
                      </div>
                      <div style="margin-top: 4px;">
                        <strong style="color: var(--text-secondary);">LEGACY:</strong>
                        <span style="color: var(--text-secondary);">?ui=debugger (bypasses auth)</span>
                      </div>
                    </div>
                  </div>
                `);
              } else {
                $url.text('Not deployed');
              }
            })
            .catch(error => {
              const escapedError = window.UI.escapeHtml(String(error.message || 'Unknown error'));
              $url.text(`Error: ${escapedError}`);
              $('#deploymentHealth').removeClass('healthy').addClass('error');
              $('#deploymentHealthText').text('Error');
            });
        },

        loadTriggers() {
          const $triggers = $('#triggersList').html('<div class="loading"></div>');

          if (typeof google === 'undefined' || !google.script?.run) {
            $triggers.html('Not available (google.script.run not loaded)');
            return;
          }

          clientState.run('ScriptApp.getProjectTriggers().map(t => ({ functionName: t.getHandlerFunction(), triggerSource: t.getTriggerSource().toString(), eventType: t.getEventType().toString() }))')
            .then(triggers => {
              if (triggers?.length) {
                const html = triggers.map(({functionName, eventType, triggerSource}) => {
                  const escapedFunctionName = window.UI.escapeHtml(String(functionName || ''));
                  const escapedEventType = window.UI.escapeHtml(String(eventType || ''));
                  const escapedTriggerSource = window.UI.escapeHtml(String(triggerSource || ''));

                  return `
                    <div class="trigger-item">
                      <div class="trigger-header">
                        <span class="trigger-function">${escapedFunctionName}</span>
                        <span class="trigger-type">${escapedEventType}</span>
                      </div>
                      <div style="font-size: 11px; color: var(--text-secondary);">
                        Source: ${escapedTriggerSource}
                      </div>
                    </div>
                  `;
                }).join('');
                $triggers.html(html);
              } else {
                $triggers.html('<div class="empty-state">No triggers found</div>');
              }
            })
            .catch(error => {
              const escapedError = window.UI.escapeHtml(String(error.message || 'Unknown error'));
              $triggers.html(`<div class="empty-state">Error loading triggers: ${escapedError}</div>`);
            });
        },

        loadProcesses() {
          const $processes = $('#processesList').html('<div class="loading"></div>');

          if (typeof google === 'undefined' || !google.script?.run) {
            $processes.html('Not available (google.script.run not loaded)');
            return;
          }

          clientState.run(`
            try {
              const logs = Logger.getLog();
              const lines = logs.split('\n').filter(line => line.trim());
              const processes = [];
              
              // Parse log lines to extract process information
              let currentProcess = null;
              for (let i = 0; i < Math.min(lines.length, 50); i++) {
                const line = lines[i];
                
                // Look for execution patterns
                if (line.includes('[LOAD] Loading module:') || line.includes('Executing:')) {
                  const match = line.match(/(?:Loading module:|Executing:)\s+(\S+)/);
                  if (match) {
                    currentProcess = {
                      functionName: match[1],
                      status: 'COMPLETED',
                      timestamp: line.substring(0, 24),
                      duration: 'N/A'
                    };
                    processes.push(currentProcess);
                  }
                } else if (line.includes('[OK]') && currentProcess) {
                  currentProcess.status = 'COMPLETED';
                } else if (line.includes('Error') || line.includes('[ERROR]')) {
                  if (currentProcess) {
                    currentProcess.status = 'FAILED';
                  }
                }
              }
              
              return processes.slice(-10).reverse();
            } catch(e) {
              Logger.log('Error parsing processes: ' + e.toString());
              return [];
            }
          `)
            .then(processes => {
              if (processes?.length) {
                const html = processes.map(({functionName = 'Unknown', status, timestamp = '', duration = 'N/A'}) => {
                  const escapedFunctionName = window.UI.escapeHtml(String(functionName));
                  const escapedStatus = window.UI.escapeHtml(String(status || ''));
                  const escapedTimestamp = window.UI.escapeHtml(String(timestamp));
                  const escapedDuration = window.UI.escapeHtml(String(duration));

                  return `
                    <div class="process-item">
                      <div class="process-header">
                        <span class="process-function">${escapedFunctionName}</span>
                        <span class="process-status ${status}">${escapedStatus}</span>
                      </div>
                      <div style="font-size: 11px; color: var(--text-secondary);">
                        ${timestamp ? `Time: ${escapedTimestamp}<br>` : ''}Duration: ${escapedDuration}
                      </div>
                    </div>
                  `;
                }).join('');
                $processes.html(html);
              } else {
                $processes.html('<div class="empty-state">No recent processes found in logs</div>');
              }
            })
            .catch(error => {
              const escapedError = window.UI.escapeHtml(String(error.message || 'Unknown error'));
              $processes.html(`<div class="empty-state">Error loading processes: ${escapedError}</div>`);
            });
        }
      };

      // ES6 Script Properties Manager
      window.ScriptPropertiesManager = {
        load() {
          const $props = $('#scriptProps').html('<div class="loading"></div>');

          if (typeof google === 'undefined' || !google.script?.run) {
            $props.html('<div class="empty-state">Not available (google.script.run not loaded)</div>');
            return;
          }

          clientState.run('JSON.stringify(PropertiesService.getScriptProperties().getProperties())')
            .then(propsJson => {
              const parsed = JSON.parse(propsJson);
              const keys = Object.keys(parsed);

              if (keys.length === 0) {
                $props.html('<div class="empty-state">No properties set</div>');
                return;
              }

              const html = keys.map(key => {
                const escapedKey = window.UI.escapeHtml(key);
                const escapedValue = window.UI.escapeHtml(String(parsed[key]));
                const safeDataKey = key.replace(/"/g, '&quot;');
                const safeDataValue = String(parsed[key]).replace(/"/g, '&quot;');

                return `
                  <div class="context-item" style="position: relative; padding-right: 60px;">
                    <div style="flex: 1;">
                      <div><span class="key">${escapedKey}</span></div>
                      <div><span class="value" style="word-break: break-word;">${escapedValue}</span></div>
                    </div>
                    <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 4px;">
                      <button class="panel-btn edit-prop" data-key="${safeDataKey}" data-value="${safeDataValue}" style="font-size: 10px; padding: 2px 6px;" title="Edit property">✎</button>
                      <button class="panel-btn delete-prop" data-key="${safeDataKey}" style="font-size: 10px; padding: 2px 6px;" title="Delete property">✕</button>
                    </div>
                  </div>
                `;
              }).join('');

              $props.html(html);

              // Wire up edit/delete handlers
              $('.edit-prop').on('click', function(e) {
                e.stopPropagation();
                const key = $(this).data('key');
                const value = $(this).data('value');
                window.ScriptPropertiesManager.edit(key, value);
              });

              $('.delete-prop').on('click', function(e) {
                e.stopPropagation();
                const key = $(this).data('key');
                window.ScriptPropertiesManager.delete(key);
              });
            })
            .catch(error => {
              const escapedError = window.UI.escapeHtml(String(error.message || 'Unknown error'));
              $props.html(`<div class="empty-state">Error loading properties: ${escapedError}</div>`);
            });
        },

        add() {
          const key = prompt('Enter property name:');
          if (!key || !key.trim()) return;

          const value = prompt('Enter property value:');
          if (value === null) return;

          const escapedKey = key.trim().replace(/\\/g, '\\\\').replace(/"/g, '\\"');
          const escapedValue = value.replace(/\\/g, '\\\\').replace(/"/g, '\\"');

          clientState.run(`PropertiesService.getScriptProperties().setProperty("${escapedKey}", "${escapedValue}")`)
            .then(() => {
              window.UI.addOutput(`Added property: ${key.trim()} = ${value}`, 'success');
              window.ScriptPropertiesManager.load();
            })
            .catch(error => {
              window.UI.addOutput(`Error adding property: ${error.message}`, 'error');
            });
        },

        edit(key, currentValue) {
          const newValue = prompt(`Edit property "${key}":\n\nCurrent value: ${currentValue}\n\nEnter new value:`, currentValue);
          if (newValue === null || newValue === currentValue) return;

          const escapedKey = key.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
          const escapedValue = newValue.replace(/\\/g, '\\\\').replace(/"/g, '\\"');

          clientState.run(`PropertiesService.getScriptProperties().setProperty("${escapedKey}", "${escapedValue}")`)
            .then(() => {
              window.UI.addOutput(`Updated property: ${key} = ${newValue}`, 'success');
              window.ScriptPropertiesManager.load();
            })
            .catch(error => {
              window.UI.addOutput(`Error updating property: ${error.message}`, 'error');
            });
        },

        delete(key) {
          if (!confirm(`Delete property "${key}"?`)) return;

          const escapedKey = key.replace(/\\/g, '\\\\').replace(/"/g, '\\"');

          clientState.run(`PropertiesService.getScriptProperties().deleteProperty("${escapedKey}")`)
            .then(() => {
              window.UI.addOutput(`Deleted property: ${key}`, 'success');
              window.ScriptPropertiesManager.load();
            })
            .catch(error => {
              window.UI.addOutput(`Error deleting property: ${error.message}`, 'error');
            });
        }
      };

      // ES6 Code Executor with timing
      window.CodeExecutor = {
        async execute() {
          const $input = $('#codeInput');
          const code = $input.val().trim();

          if (!code) return;

          const startTime = performance.now();
          window.UI.addOutput(`Executing: ${code}`, 'info');

          try {
            // Check for simple assignment like "x = value" and convert to clientState.set
            const assignmentMatch = code.match(/^([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)$/);
            let actualCode = code;
            let isAssignment = false;
            let varName = null;
            
            if (assignmentMatch && !code.includes('clientState.')) {
              varName = assignmentMatch[1];
              const value = assignmentMatch[2];
              actualCode = value; // Don't auto-set, evaluate first
              isAssignment = true;
            }
            
            // Make run() and clientState available in execution scope
            const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
            const fn = new AsyncFunction('clientState', 'run', `return ${actualCode}`);
            const rawResult = await fn(clientState, clientState.run);
            
            // Extract result and logger_output from response
            let result = rawResult;
            let serverLogs = null;
            
            // Check if this is a full response object from invoke()
            if (rawResult && typeof rawResult === 'object' && 'result' in rawResult) {
              result = rawResult.result;
              serverLogs = rawResult.logger_output;
            }

            const clientTime = (performance.now() - startTime).toFixed(2);

            // If it was an assignment, store it after successful evaluation
            if (isAssignment && varName) {
              clientState.storage[varName] = result;
              window.UI.updateClientState();
              window.UI.addOutput(`Set ${varName} = ${JSON.stringify(result)}`, 'success');
            }

            if (result !== undefined) {
              const displayResult = typeof result === 'object'
                ? JSON.stringify(result, null, 2)
                : String(result);
              window.UI.addOutput(displayResult, 'success', `client: ${clientTime}ms`);
            } else {
              window.UI.addOutput('(undefined)', 'success', `client: ${clientTime}ms`);
            }
            
            // Update client state display after execution
            window.UI.updateClientState();
          } catch (error) {
            const clientTime = (performance.now() - startTime).toFixed(2);
            window.UI.addOutput(error.message, 'error', `client: ${clientTime}ms`);
          }

          // Add to command history
          window.commandHistory.add(code);
          
          $input.val('');
        }
      };

      // ES6 Resize Handler
      const ResizeHandler = {
        init() {
          const $resizer = $('#resizer');
          const $leftPanel = $('.context-panel');
          const $container = $('.main-content');
          let isResizing = false;

          $resizer.on('mousedown', () => {
            isResizing = true;
            $('body').css({ cursor: 'col-resize', userSelect: 'none' });
          });

          $(document).on('mousemove', e => {
            if (!isResizing) return;

            const containerRect = $container[0].getBoundingClientRect();
            const newWidth = e.clientX - containerRect.left;

            if (newWidth >= 250 && newWidth <= containerRect.width - 400) {
              $leftPanel.css('width', `${newWidth}px`);
            }
          });

          $(document).on('mouseup', () => {
            if (isResizing) {
              isResizing = false;
              $('body').css({ cursor: '', userSelect: '' });
            }
          });
        }
      };

      // Event Handlers
      $('.nav-link').on('click', e => {
        e.preventDefault();
        window.UI.switchTab($(e.target).data('tab'));
      });

      $('.toggle-panel').on('click', function() {
        window.UI.togglePanel($(this));
      });

      $('.clear-output').on('click', window.UI.clearOutput);

      $('.execute-btn').on('click', window.CodeExecutor.execute);

      $('#codeInput').on('keydown', e => {
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prev = window.commandHistory.getPrevious();
          $('#codeInput').val(prev);
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          const next = window.commandHistory.getNext();
          $('#codeInput').val(next);
        }
      });

      $('#codeInput').on('keypress', e => {
        if (e.key === 'Enter') window.CodeExecutor.execute();
      });

      // Collapsible sections
      $('.context-section h3').on('click', function(e) {
        // Don't collapse if clicking buttons
        if ($(e.target).is('#refreshProcesses, #clearClientState') || 
            $(e.target).closest('#refreshProcesses, #clearClientState').length) {
          return;
        }
        $(this).closest('.context-section').toggleClass('collapsed');
      });

      // Refresh Processes button handler
      $('#refreshProcesses').on('click', function(e) {
        e.stopPropagation();
        window.DataLoader?.loadProcesses();
      });

      // Clear Client State button handler
      $('#clearClientState').on('click', function(e) {
        e.stopPropagation();
        if (confirm('Clear all client state variables?')) {
          clientState.clear();
        }
      });

      // Script Properties button handlers
      $('#refreshScriptProps').on('click', function(e) {
        e.stopPropagation();
        window.ScriptPropertiesManager?.load();
      });

      $('#addScriptProp').on('click', function(e) {
        e.stopPropagation();
        window.ScriptPropertiesManager?.add();
      });

      // Load session info and script properties on startup
      const loadInitialContext = async () => {
        if (typeof google === 'undefined' || !google.script?.run) {
          $('#timezone').text('Not available');
          $('#locale').text('Not available');
          $('#scriptProps').html('<div class="empty-state">Not available (google.script.run not loaded)</div>');
          return;
        }

        // Load timezone
        try {
          const timezone = await clientState.run('Session.getScriptTimeZone()');
          $('#timezone').text(timezone || 'Unknown');
        } catch (e) {
          $('#timezone').text('Error loading');
        }

        // Load locale
        try {
          const locale = await clientState.run('Session.getActiveUserLocale()');
          $('#locale').text(locale || 'Unknown');
        } catch (e) {
          $('#locale').text('Error loading');
        }

        // Load script properties
        try {
          const props = await clientState.run('JSON.stringify(PropertiesService.getScriptProperties().getProperties())');
          const parsed = JSON.parse(props);
          const keys = Object.keys(parsed);
          
          if (keys.length === 0) {
            $('#scriptProps').html('<div class="empty-state">No properties set</div>');
          } else {
            const html = keys.map(key => `
              <div class="context-item" title="${key}\n\nValue:\n${parsed[key]}">
                <span class="key">${key}</span>
                <span class="value">${parsed[key]}</span>
              </div>
            `).join('');
            $('#scriptProps').html(html);
          }
        } catch (e) {
          $('#scriptProps').html('<div class="empty-state">Error loading properties</div>');
        }

        // Load Script ID and User Email
        try {
          const scriptId = await clientState.run('ScriptApp.getScriptId()');
          $('#scriptId').text(scriptId || 'N/A');
        } catch (e) {
          $('#scriptId').text('N/A');
        }

        try {
          const email = await clientState.run('Session.getActiveUser().getEmail()');
          $('#userEmail').text(email || 'N/A');
        } catch (e) {
          $('#userEmail').text('N/A');
        }
      };

      // Initialize
      ResizeHandler.init();
      window.UI.restorePanelStates();
      window.UI.updateClientState();

      // Check google.script.run availability
      if (typeof google === 'undefined' || !google.script?.run) {
        $('#deploymentUrl').text('Not available (google.script.run not loaded)').css('color', 'var(--text-secondary)');
        $('#deploymentHealth').css('color', 'var(--text-secondary)');
        $('#deploymentHealthText').text('N/A');
      } else {
        // Load context info if google.script.run is available
        setTimeout(loadInitialContext, 1000);
      }

      // Open in Editor button handler
      $('#openEditorBtn').on('click', async () => {
        const scriptId = $('#scriptId').text();
        if (scriptId && scriptId !== 'Loading...' && scriptId !== 'N/A') {
          window.open(`https://script.google.com/d/${scriptId}/edit`, '_blank');
        } else {
          window.UI.addOutput('Script ID not available yet', 'warning');
        }
      });

      // Click-to-copy Script ID handler
      $('#scriptId').on('click', async function() {
        const scriptId = $(this).text();
        if (scriptId && scriptId !== 'Loading...' && scriptId !== 'N/A') {
          try {
            await navigator.clipboard.writeText(scriptId);
            window.UI.addOutput('Script ID copied to clipboard', 'success');
            
            // Visual feedback
            const originalText = $(this).text();
            $(this).text('Copied!');
            setTimeout(() => {
              $(this).text(originalText);
            }, 1000);
          } catch (error) {
            window.UI.addOutput('Failed to copy Script ID', 'error');
          }
        }
      });

      // Initial messages
      window.UI.addOutput('Gas Debugger Console initialized', 'success');
      window.UI.addOutput('Type JavaScript code in the input below and press Enter to execute', 'info');
      window.UI.addOutput('Use run(<javascript>) to execute server-side code', 'info');
      window.UI.addOutput('Use clientState.set("varName", value) to store variables', 'info');
      window.UI.addOutput('clientState object is globally accessible from browser console', 'info');
      window.UI.addOutput('Authorization may be required on first execution', 'warning');
    });
  </script>
</body>
</html>